<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File as code</title>
    <link rel="icon" href="https://img.icons8.com/ios/100/image--v1.png" type="image/png">

    <!-- Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons (optional) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="wasm_exec.js"></script>
    <script>
        const go = new Go();
        WebAssembly.instantiateStreaming(fetch("fac.wasm"), go.importObject).then((result) => {
            go.run(result.instance);

            window.showAlert = function(message) {
                alert(message);
            };
        });

        
        window.onload = function() {
            showFAC(); // Default to show File as Code

            var textarea = document.getElementById('textOutput');
            textarea.addEventListener('input', function() {
                autoResizeFacOutput(textarea);
            });
            // Initial call to set the correct height on page load
            autoResizeFacOutput(textarea);
        };
    </script>

    <style>
        #textOutput {
            font-family: monospace; /* Use monospace font for proper alignment */
            white-space: pre; /* Preserve whitespace */
            min-height: 90px;
            max-height: 900px;
            overflow-y: auto; /* Scrollbar if needed */
        }

        #infoParagraph {
            font-family: monospace; /* Use monospace font for proper alignment */
            border: 0.5px solid #ddd;
            border-radius: 5px;
            margin-top: 10px;
        }

        .info-link {
            display: block;
            margin-top: 10px;
            font-size: 1rem;
            text-align: left;
        }

        .invisible {
            visibility: hidden;
            height: 0px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2 class="mb-4" id="title">File as code</h2>
        
        <!-- Toggle Buttons -->
        <div class="btn-group" role="group">
            <button id="facButton" data-toggle="tooltip" type="button" class="btn btn-primary" onclick="showFAC()">File as code</button>
            <button id="cafButton" data-toggle="tooltip" type="button" class="btn btn-secondary" onclick="showCAF()">Code as file</button>
        </div>

        <a class="btn btn-link mt-3 info-link" data-toggle="collapse" href="#infoParagraph" role="button" aria-expanded="false" aria-controls="infoParagraph">
            Info <i class="fas fa-chevron-down"></i>
        </a>

        <!-- Collapsible Info Section -->
        <div class="collapse" id="infoParagraph">
            <div class="card card-body">
                <p id="infoText">More in showFAC() and showCAF()</p>
            </div>
        </div>

        <!-- FAC Content -->
        <div id="facContent" class="mt-4" style="display: none;">
            <!-- File Input -->
            <div class="form-group">
                <label for="fileInput">Select File</label>
                <input type="file" class="form-control" id="fileInput">
            </div>

            <!-- Combo Box for Decimal, Binary, Char -->
            <div class="form-group">
                <label for="outputFormat">Numbers representation</label>
                <select class="form-control" id="outputFormat">
                    <option>Hex</option>
                    <option>Char</option>
                    <option>Binary</option>
                    <option>Decimal</option>
                </select>
            </div>

            <!-- Individual Checkboxes -->
            <div class="form-group">
                <label>Options</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="arrayCheckbox">
                    <label class="form-check-label" for="arrayCheckbox">Array</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="cppCheckbox">
                    <label class="form-check-label" for="cppCheckbox">C++</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="inlineCheckbox">
                    <label class="form-check-label" for="inlineCheckbox">Inline</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="shrinkCheckbox">
                    <label class="form-check-label" for="shrinkCheckbox">Shrink</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ucCheckbox">
                    <label class="form-check-label" for="ucCheckbox">Decompress image</label>
                </div>
            </div>

            <!-- Combo Box for Speed/Compression -->
            <div class="form-group">
                <label for="speedCompression">Compression algorithm</label>
                <select class="form-control" id="compressionalgorithm">
                    <option>None</option>
                    <option>gzip</option>
                    <option>zlib</option>
                </select>
            </div>

            <!-- Combo Box for Speed/Compression -->
            <div class="form-group">
                <label for="speedCompression">Compression level</label>
                <select class="form-control" id="speedCompression">
                    <option>Default</option>
                    <option>Best speed</option>
                    <option>Best compression</option>
                </select>
            </div>

            <!-- Submit Button -->
            <button class="btn btn-primary" onclick="fac()">Convert</button>

            <div class="row align-items-center mt-4">
                <div class="col-auto">
                    <div class="form-check col-auto">
                        <input class="form-check-input" type="checkbox" id="outputVisible" onclick="toggleOutput()" checked>
                        <label class="form-check-label" for="outputVisible">Output visible</label>
                    </div>
                </div>
    
                <div class="col-auto">
                    <button class="btn btn-primary" onclick="clearOutput()">Clear output</button>
                </div>
            </div>

            <div class="form-group mt-4" id="textOutputContainer">
                <label for="textOutput">Output</label>
                <textarea id="textOutput" name="textOutput" class="form-control" rows="10"></textarea>
            </div>

            <div id="buttonsContainer" class="mb-4"></div>
        </div>


        <!-- CAF Content -->
        <div id="cafContent" class="mt-4" style="display: none;">
            <!-- File Input -->
            <div class="form-group">
                <label for="fileInputCaf">Select File</label>
                <input type="file" class="form-control" id="fileInputCaf">
            </div>

            <!-- Combo Box for PNG/JPG -->
            <div class="form-group">
                <label for="imageFormat">Image format</label>
                <select class="form-control" id="imageFormat">
                    <option>None</option>
                    <option>PNG</option>
                    <option>JPG</option>
                </select>
            </div>

            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="image_compressed" checked>
                <label class="form-check-label" for="image_compressed">Image compressed</label>
            </div>

            <!-- Combo Box for Compression -->
            <div class="form-group">
                <label for="compressionCaf">Compression used</label>
                <select class="form-control" id="compressionCaf">
                    <option>None</option>
                    <option>gzip</option>
                    <option>zlib</option>
                </select>
            </div>

            <button class="btn btn-primary" onclick="caf()">Convert</button>

            <div id="imageContainer" class="mt-4"></div>
        </div>
    </div>

    <script>
        function showFAC() {
            document.getElementById('facContent').style.display = 'block';
            document.getElementById('cafContent').style.display = 'none';
            document.getElementById("title").innerText = "File as code";
            document.getElementById("facButton").classList.remove("btn-secondary");
            document.getElementById("facButton").classList.add("btn-primary");
            document.getElementById("cafButton").classList.remove("btn-primary");
            document.getElementById("cafButton").classList.add("btn-secondary");

            document.getElementById('infoText').innerText =
            `File as code: This option allows you to convert a file into code format for embedding it in your project.
            How to use:

            Select a file, this can be any type of file.
            Numbers representation: If you want the C-array to contain decimal, hex, binary or char values

            Options:
                Array: Use a std::array instead of a C-Style array
                TODO: FIX: C++: Use C++-Style variable qualifiers (constexpr)
                Decompress image: Write decompressed data to file (jpeg, png, gif)
                Inline: Inline the variables (supported from C++17 onwards)
                Shrink: Make the output array as small as possible (Not easy to read), will automatically use decimal as output format

            Compression algorithm: If you need the array to be smaller try to compress it
                None: Don't compress
                gzip: Use the gzip compression algorithm
                zlib: Use the zlib compression algorithm

            Compression level: If a compression algorithm is used select the desired compression results, if 'None' is set ignored
                Default: default compression level
                Best speed: Use the compression level for best speed
                Best compression: Use the compression level for best compression
                
            Output visible: Toggle the output window, can be useful if your file is very large. The download option will still be available.`;
        }

        function showCAF() {
            document.getElementById('facContent').style.display = 'none';
            document.getElementById('cafContent').style.display = 'block';
            document.getElementById("title").innerText = "Code as file";
            document.getElementById("facButton").classList.remove("btn-primary");
            document.getElementById("facButton").classList.add("btn-secondary");
            document.getElementById("cafButton").classList.remove("btn-secondary");
            document.getElementById("cafButton").classList.add("btn-primary");
            document.getElementById('infoText').innerText =
            `File as code: This option allows you to convert a C-array into a file.
            How to use:

            Select a file, it should ideally be in the format of the 'File as code' output or just contain a c-array.

            Image format:
                If your C-array is either a png or a jpg image select it respectively, it will still work if you select none for images,
                however it won't be able to convert decompressed images into their compressed counter part.

            Image compressed:
                If image format is either png or jpg select if you C-array contains the image still in it's image format.
                This means if your C-array contains the png and you selected png click the box, if it contains the decompressed png select png and dont tick.

            Compression used:
                If you used the 'File as code' tool to convert a file into a C-array and applies compression you have to select the used compression algorithm.`;
        }


        function toggleOutput()
        {
            var elem = document.getElementById('textOutputContainer');
            if (elem.classList.contains('invisible'))
            {
                elem.classList.remove('invisible');
            }
            else
            {
                elem.classList.add('invisible');
            }
        }


        function clearOutput()
        {
            document.getElementById('textOutput').value = ""
            autoResizeFacOutput(document.getElementById('textOutput'));

            const existingDownloadButton = document.getElementById('downloadButton');
            if (existingDownloadButton) {
                existingDownloadButton.remove();
            }
        }


        function autoResizeFacOutput(textarea) {
            textarea.style.height = 'auto'; // Reset height to auto
            textarea.style.height = textarea.scrollHeight + 'px'; // Set height based on scrollHeight
        }


        fac = function()
        {
            const fileInput = document.getElementById('fileInput');
            if (fileInput.files.length === 0)
            {
                alert('Error: Please select a file');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(event)
            {
                const arrayBuffer = event.target.result;
                // Convert the ArrayBuffer to a Uint8Array
                const uint8Array = new Uint8Array(arrayBuffer);

                var cppstyle = document.getElementById("cppCheckbox").checked;
                var shrink = document.getElementById("shrinkCheckbox").checked;
                var stdarray = document.getElementById("arrayCheckbox").checked;
                var inlineVars = document.getElementById("inlineCheckbox").checked;
                var uncompress = document.getElementById("ucCheckbox").checked;
                var outputRep = document.getElementById("outputFormat").selectedIndex;
                var compression = document.getElementById("compressionalgorithm").selectedIndex;
                var compressLvl = document.getElementById("speedCompression").selectedIndex;

                let errorMsg = FacJS(uint8Array, !cppstyle /* fac excepts cstyle */, shrink, stdarray, inlineVars, uncompress, outputRep, compression, compressLvl);
                if (errorMsg)
                {
                    alert("Error message: " + errorMsg);

                    const existingDownloadButton = document.getElementById('downloadButton');
                    if (existingDownloadButton) {
                        existingDownloadButton.remove();
                    }
                }
                else
                {
                    autoResizeFacOutput(document.getElementById('textOutput'));

                    let downloadButton = document.getElementById('downloadButton');
                    if (!downloadButton)
                    {
                        downloadButton = document.createElement('button');
                        downloadButton.id = 'downloadButton';
                        downloadButton.className = 'btn btn-success';
                        downloadButton.textContent = 'Save output';
                        document.getElementById('buttonsContainer').appendChild(downloadButton);
                    }

                    downloadButton.onclick = function() {
                        const textOutput = document.getElementById('textOutput').value;
                        const blob = new Blob([textOutput], { type: 'text/plain' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'array.cpp'; // Name of the downloaded file
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    };
                }
            };
            reader.readAsArrayBuffer(file);
        }


        function displayImage(uint8Array, imageExtension) {
            // Convert Uint8Array to Blob
            const blob = new Blob([uint8Array], { type: 'application/octet-stream' });

            // Create an Object URL
            const url = URL.createObjectURL(blob);

            // Create an img element
            const img = document.createElement('img');
            img.src = url;
            img.alt = 'Generated Image';
            img.className = 'img-fluid'; // Bootstrap class to make image responsive

            // Create a download button
            const downloadButton = document.createElement('a');
            downloadButton.href = url;
            downloadButton.download = 'image' + imageExtension; // Default filename for the download
            downloadButton.className = 'btn btn-success mt-3 mb-5'; // Bootstrap classes for styling
            downloadButton.textContent = imageExtension ? 'Save Image' : "Save";

            // Add img element and button to the DOM
            const container = document.getElementById('imageContainer');
            container.innerHTML = ''; // Clear any previous content
            if (imageExtension) // is an image
                container.appendChild(img);
            container.appendChild(downloadButton);
        }


        caf = function()
        {
            const fileInput = document.getElementById('fileInputCaf');
            if (fileInput.files.length === 0)
            {
                alert('Error: Please select a file');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(event) {
                const arrayBuffer = event.target.result;
                // Convert the ArrayBuffer to a Uint8Array
                const uint8Array = new Uint8Array(arrayBuffer);

                var compression = document.getElementById("compressionCaf").selectedIndex;
                var imageFormat = document.getElementById("imageFormat").selectedIndex;
                if (document.getElementById("image_compressed").checked)
                    imageFormat = 0;

                let result = CafJS(uint8Array, imageFormat, compression);
                if (result == null)
                {
                    const imageCont = document.getElementById('imageContainer');
                    if (imageCont) {
                        imageCont.remove();
                    }
                }
                else
                {
                    imageExtension = null;
                    idx = document.getElementById("imageFormat").selectedIndex;
                    if (idx == 1)
                        imageExtension = ".png"
                    else if (idx == 2)
                        imageExtension == ".jpg"
                    displayImage(result, imageExtension)
                }
            };
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>

<footer class="footer text-center text-muted mt-5">
    <div class="container">
        <p class="mb-0">
            <a href="https://icons8.com/icon/53386/image" target="_blank" rel="noopener noreferrer">Image</a> icon by 
            <a href="https://icons8.com" target="_blank" rel="noopener noreferrer">Icons8</a>
        </p>
    </div>
</footer>
</html>
