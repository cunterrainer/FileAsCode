<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File as code</title>
    <!-- Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script src="wasm_exec.js"></script>
    <script>
        const go = new Go();
        WebAssembly.instantiateStreaming(fetch("fac.wasm"), go.importObject).then((result) => {
            go.run(result.instance);

            window.showAlert = function(message) {
                alert(message);
            };
        });

        
        window.onload = function() {
            showFAC(); // Default to show File as Code

            var textarea = document.getElementById('textOutput');
            textarea.addEventListener('input', function() {
                autoResizeFacOutput(textarea);
            });
            // Initial call to set the correct height on page load
            autoResizeFacOutput(textarea);
        };
    </script>

    <style>
        #textOutput {
            font-family: monospace; /* Use monospace font for proper alignment */
            white-space: pre; /* Preserve whitespace */
            min-height: 90px;
            max-height: 900px;
            overflow-y: auto; /* Scrollbar if needed */
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2 class="mb-4" id="title">File as code</h2>
        
        <!-- Toggle Buttons -->
        <div class="btn-group" role="group">
            <button id="facButton" data-toggle="tooltip" type="button" class="btn btn-primary" onclick="showFAC()">File as code</button>
            <button id="cafButton" data-toggle="tooltip" type="button" class="btn btn-secondary" onclick="showCAF()">Code as file</button>
        </div>

        <!-- FAC Content -->
        <div id="facContent" class="mt-4" style="display: none;">
            <!-- File Input -->
            <div class="form-group">
                <label for="fileInput">Select File</label>
                <input type="file" class="form-control" id="fileInput">
            </div>

            <!-- Combo Box for Decimal, Binary, Char -->
            <div class="form-group">
                <label for="outputFormat">Numbers representation</label>
                <select class="form-control" id="outputFormat">
                    <option>Hex</option>
                    <option>Char</option>
                    <option>Binary</option>
                    <option>Decimal</option>
                </select>
            </div>

            <!-- Individual Checkboxes -->
            <div class="form-group">
                <label>Options</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="arrayCheckbox">
                    <label class="form-check-label" for="arrayCheckbox">Array</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="cppCheckbox">
                    <label class="form-check-label" for="cppCheckbox">C++</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ucCheckbox">
                    <label class="form-check-label" for="ucCheckbox">Uncompress</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="inlineCheckbox">
                    <label class="form-check-label" for="inlineCheckbox">Inline</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="shrinkCheckbox">
                    <label class="form-check-label" for="shrinkCheckbox">Shrink</label>
                </div>
            </div>

            <!-- Combo Box for Speed/Compression -->
            <div class="form-group">
                <label for="speedCompression">Compression algorithm</label>
                <select class="form-control" id="compressionalgorithm">
                    <option>None</option>
                    <option>gzip</option>
                    <option>zlib</option>
                </select>
            </div>

            <!-- Combo Box for Speed/Compression -->
            <div class="form-group">
                <label for="speedCompression">Compression level</label>
                <select class="form-control" id="speedCompression">
                    <option>Default</option>
                    <option>Best speed</option>
                    <option>Best compression</option>
                </select>
            </div>

            <!-- Submit Button -->
            <button class="btn btn-primary" onclick="fac()">Convert</button>

            <div class="form-group mt-4">
                <label for="textOutput">Output</label>
                <textarea id="textOutput" name="textOutput" class="form-control" rows="10"></textarea>
            </div>

            <div id="saveButtonContainer" class="mt-4"></div>
        </div>


        <!-- CAF Content -->
        <div id="cafContent" class="mt-4" style="display: none;">
            <!-- File Input -->
            <div class="form-group">
                <label for="fileInputCaf">Select File</label>
                <input type="file" class="form-control" id="fileInputCaf">
            </div>

            <!-- Combo Box for PNG/JPG -->
            <div class="form-group">
                <label for="imageFormat">Image Format</label>
                <select class="form-control" id="imageFormat">
                    <option>None</option>
                    <option>PNG</option>
                    <option>JPG</option>
                </select>
            </div>

            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="image_compressed">
                <label class="form-check-label" for="image_compressed">Image compressed</label>
            </div>

            <!-- Combo Box for Compression -->
            <div class="form-group">
                <label for="compressionCaf">Compression used</label>
                <select class="form-control" id="compressionCaf">
                    <option>None</option>
                    <option>gzip</option>
                    <option>zlib</option>
                </select>
            </div>

            <button class="btn btn-primary" onclick="caf()">Convert</button>

            <div id="imageContainer" class="mt-4"></div>
        </div>
    </div>

    <script>
        function showFAC() {
            document.getElementById('facContent').style.display = 'block';
            document.getElementById('cafContent').style.display = 'none';
            document.getElementById("title").innerText = "File as code";
            document.getElementById("facButton").classList.remove("btn-secondary");
            document.getElementById("facButton").classList.add("btn-primary");
            document.getElementById("cafButton").classList.remove("btn-primary");
            document.getElementById("cafButton").classList.add("btn-secondary");
        }

        function showCAF() {
            document.getElementById('facContent').style.display = 'none';
            document.getElementById('cafContent').style.display = 'block';
            document.getElementById("title").innerText = "Code as file";
            document.getElementById("facButton").classList.remove("btn-primary");
            document.getElementById("facButton").classList.add("btn-secondary");
            document.getElementById("cafButton").classList.remove("btn-secondary");
            document.getElementById("cafButton").classList.add("btn-primary");
        
        }


        function autoResizeFacOutput(textarea) {
            textarea.style.height = 'auto'; // Reset height to auto
            textarea.style.height = textarea.scrollHeight + 'px'; // Set height based on scrollHeight
        }


        fac = function()
        {
            const fileInput = document.getElementById('fileInput');
            if (fileInput.files.length === 0)
            {
                alert('Error: Please select a file');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(event)
            {
                const arrayBuffer = event.target.result;
                // Convert the ArrayBuffer to a Uint8Array
                const uint8Array = new Uint8Array(arrayBuffer);

                var cstyle = document.getElementById("cppCheckbox").checked;
                var shrink = document.getElementById("shrinkCheckbox").checked;
                var stdarray = document.getElementById("arrayCheckbox").checked;
                var inlineVars = document.getElementById("inlineCheckbox").checked;
                var uncompress = document.getElementById("ucCheckbox").checked;
                var outputRep = document.getElementById("outputFormat").selectedIndex;
                var compression = document.getElementById("compressionalgorithm").selectedIndex;
                var compressLvl = document.getElementById("speedCompression").selectedIndex;

                // TODO: add limit for output e.g. too large of an image file
                let errorMsg = FacJS(uint8Array, cstyle, shrink, stdarray, inlineVars, uncompress, outputRep, compression, compressLvl);
                if (errorMsg)
                {
                    alert("Error message: " + errorMsg);
                }
                else
                {
                    autoResizeFacOutput(document.getElementById('textOutput'));
                    const blob = new Blob([textOutput.value], { type: 'application/octet-stream' });
                    const url = URL.createObjectURL(blob);
                    // Create a download button
                    const downloadButton = document.createElement('a');
                    downloadButton.href = url;
                    downloadButton.download = 'file.cpp'; // Default filename for the download
                    downloadButton.className = 'btn btn-primary mt-3 mb-5'; // Bootstrap classes for styling
                    downloadButton.textContent = "Save";

                    const container = document.getElementById('saveButtonContainer');
                    container.innerHTML = ''; // Clear any previous content
                    container.appendChild(downloadButton);
                }
            };
            reader.readAsArrayBuffer(file);
        }


        function displayImage(uint8Array, imageExtension) {
            // Convert Uint8Array to Blob
            const blob = new Blob([uint8Array], { type: 'application/octet-stream' });

            // Create an Object URL
            const url = URL.createObjectURL(blob);

            // Create an img element
            const img = document.createElement('img');
            img.src = url;
            img.alt = 'Generated Image';
            img.className = 'img-fluid'; // Bootstrap class to make image responsive

            // Create a download button
            const downloadButton = document.createElement('a');
            downloadButton.href = url;
            downloadButton.download = 'image' + imageExtension; // Default filename for the download
            downloadButton.className = 'btn btn-primary mt-3 mb-5'; // Bootstrap classes for styling
            downloadButton.textContent = imageExtension ? 'Save Image' : "Save";

            // Add img element and button to the DOM
            const container = document.getElementById('imageContainer');
            container.innerHTML = ''; // Clear any previous content
            if (imageExtension) // is an image
                container.appendChild(img);
            container.appendChild(downloadButton);
        }


        caf = function()
        {
            const fileInput = document.getElementById('fileInputCaf');
            if (fileInput.files.length === 0)
            {
                alert('Error: Please select a file');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(event) {
                const arrayBuffer = event.target.result;
                // Convert the ArrayBuffer to a Uint8Array
                const uint8Array = new Uint8Array(arrayBuffer);

                var compression = document.getElementById("compressionCaf").selectedIndex;
                var imageFormat = document.getElementById("imageFormat").selectedIndex;
                if (document.getElementById("image_compressed").checked)
                    imageFormat = 0;

                let result = CafJS(uint8Array, imageFormat, compression);
                if (result != null)
                {
                    imageExtension = null;
                    idx = document.getElementById("imageFormat").selectedIndex;
                    if (idx == 1)
                        imageExtension = ".png"
                    else if (idx == 2)
                        imageExtension == ".jpg"
                    displayImage(result, imageExtension)
                }
            };
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>
