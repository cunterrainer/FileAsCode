<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File as code</title>
    <!-- Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

    <script src="wasm_exec.js"></script>
    <script>
        const go = new Go();
        WebAssembly.instantiateStreaming(fetch("json.wasm"), go.importObject).then((result) => {
            go.run(result.instance);
        });
    </script>

    <style>
        #textOutput {
            font-family: monospace; /* Use monospace font for proper alignment */
            white-space: pre; /* Preserve whitespace */
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2 class="mb-4" id="title">File as code</h2>
        
        <!-- Toggle Buttons -->
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-primary" onclick="showFAC()">File as code</button>
            <button type="button" class="btn btn-secondary" onclick="showCAF()">Code as file</button>
        </div>

        <!-- FAC Content -->
        <div id="facContent" class="mt-4" style="display: none;">
            <!-- File Input -->
            <div class="form-group">
                <label for="fileInput">Select File</label>
                <input type="file" class="form-control" id="fileInput">
            </div>

            <!-- Combo Box for Decimal, Binary, Char -->
            <div class="form-group">
                <label for="outputFormat">Number Type</label>
                <select class="form-control" id="outputFormat">
                    <option>Hex</option>
                    <option>Char</option>
                    <option>Binary</option>
                    <option>Decimal</option>
                </select>
            </div>

            <!-- Individual Checkboxes -->
            <div class="form-group">
                <label>Options</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="arrayCheckbox">
                    <label class="form-check-label" for="arrayCheckbox">Array</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="cppCheckbox">
                    <label class="form-check-label" for="cppCheckbox">C++</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ucCheckbox">
                    <label class="form-check-label" for="ucCheckbox">UC</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="inlineCheckbox">
                    <label class="form-check-label" for="inlineCheckbox">Inline</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="shrinkCheckbox">
                    <label class="form-check-label" for="shrinkCheckbox">Shrink</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="gzipCheckbox">
                    <label class="form-check-label" for="gzipCheckbox">Gzip</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="zlibCheckbox">
                    <label class="form-check-label" for="zlibCheckbox">Zlib</label>
                </div>
            </div>

            <!-- Combo Box for Speed/Compression -->
            <div class="form-group">
                <label for="speedCompression">Speed/Compression</label>
                <select class="form-control" id="speedCompression">
                    <option>Default</option>
                    <option>Best speed</option>
                    <option>Best compression</option>
                </select>
            </div>

            <!-- Reverse Checkbox -->
            <div class="form-group form-check">
                <input type="checkbox" class="form-check-input" id="reverseCheckbox">
                <label class="form-check-label" for="reverseCheckbox">Reverse</label>
            </div>

            <!-- Submit Button -->
            <button class="btn btn-primary" onclick="fac()">Submit</button>

            <div class="form-group mt-4">
                <label for="textOutput">Text Output</label>
                <textarea id="textOutput" name="textOutput" class="form-control" rows="10"></textarea>
            </div>
        </div>


        <!-- CAF Content -->
        <div id="cafContent" class="mt-4" style="display: none;">
            <!-- File Input -->
            <div class="form-group">
                <label for="fileInputCaf">Select File</label>
                <input type="file" class="form-control" id="fileInputCaf">
            </div>

            <!-- Combo Box for PNG/JPG -->
            <div class="form-group">
                <label for="imageFormat">Image Format</label>
                <select class="form-control" id="imageFormat">
                    <option>None</option>
                    <option>PNG</option>
                    <option>JPG</option>
                </select>
            </div>

            <!-- Combo Box for Compression -->
            <div class="form-group">
                <label for="compressionCaf">Compression used</label>
                <select class="form-control" id="compressionCaf">
                    <option>None</option>
                    <option>gzip</option>
                    <option>zlib</option>
                </select>
            </div>

            <button class="btn btn-primary" onclick="caf()">Submit</button>

            <div id="imageContainer" class="mt-4"></div>
        </div>
    </div>

    <script>
        function showFAC() {
            document.getElementById('facContent').style.display = 'block';
            document.getElementById('cafContent').style.display = 'none';
            document.getElementById("title").innerText = "File as code"
        }

        function showCAF() {
            document.getElementById('facContent').style.display = 'none';
            document.getElementById('cafContent').style.display = 'block';
            document.getElementById("title").innerText = "Code as file"
        }


        fac = function()
        {
            const fileInput = document.getElementById('fileInput');
            if (fileInput.files.length === 0)
            {
                alert('Error: Please select a file');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(event)
            {
                const arrayBuffer = event.target.result;
                // Convert the ArrayBuffer to a Uint8Array
                const uint8Array = new Uint8Array(arrayBuffer);

                var cstyle = document.getElementById("cppCheckbox").checked;
                var shrink = document.getElementById("shrinkCheckbox").checked;
                var stdarray = document.getElementById("arrayCheckbox").checked;
                var inlineVars = document.getElementById("inlineCheckbox").checked;
                var uncompress = document.getElementById("ucCheckbox").checked;
                var outputRep = document.getElementById("outputFormat").selectedIndex;
                var compression = document.getElementById("gzipCheckbox").checked ? 1 : (document.getElementById("zlibCheckbox").checked ? 2 : 0);
                var compressLvl = document.getElementById("speedCompression").selectedIndex;

                // TODO: add limit for output e.g. too large of an image file
                let errorMsg = FacJS(uint8Array, cstyle, shrink, stdarray, inlineVars, uncompress, outputRep, compression, compressLvl);
                if (errorMsg)
                {
                    alert("Error message: " + errorMsg);
                }
            };
            reader.readAsArrayBuffer(file);
        }


        function displayImage(uint8Array) {
            // Convert Uint8Array to Blob
            const blob = new Blob([uint8Array], { type: 'application/octet-stream' });

            // Create an Object URL
            const url = URL.createObjectURL(blob);

            // Create an img element
            const img = document.createElement('img');
            img.src = url;
            img.alt = 'Generated Image';
            img.className = 'img-fluid'; // Bootstrap class to make image responsive

            // Create a download button
            const downloadButton = document.createElement('a');
            downloadButton.href = url;
            downloadButton.download = 'image.png'; // Default filename for the download
            downloadButton.className = 'btn btn-primary mt-3'; // Bootstrap classes for styling
            downloadButton.textContent = 'Download Image';

            // Add img element and button to the DOM
            const container = document.getElementById('imageContainer');
            container.innerHTML = ''; // Clear any previous content
            container.appendChild(img);
            container.appendChild(downloadButton);
        }


        caf = function()
        {
            const fileInput = document.getElementById('fileInputCaf');
            if (fileInput.files.length === 0)
            {
                alert('Error: Please select a file');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(event) {
                const arrayBuffer = event.target.result;
                // Convert the ArrayBuffer to a Uint8Array
                const uint8Array = new Uint8Array(arrayBuffer);

                var compression = document.getElementById("compressionCaf").selectedIndex;
                var imageFormat = document.getElementById("imageFormat").selectedIndex;

                let errorMsg = CafJS(uint8Array, imageFormat, compression);
                displayImage(errorMsg)
                //const blob = new Blob([errorMsg], { type: 'application/octet-stream' });
                //const url = URL.createObjectURL(blob);

                // Create a download link
                //const a = document.createElement('a');
                //a.href = url;
                //a.download = 'output.png';
                //document.body.appendChild(a);
                //a.click();
                //document.body.removeChild(a);


                // Convert result to a Blob if needed, or handle it as a byte array
                //const blob = new Blob([errorMsg], { type: 'application/octet-stream' });
                //const url = URL.createObjectURL(blob);

                // Example: Create a download link
                //const a = document.createElement('a');
                //a.href = url;
                //a.download = 'output.bin';
                //document.body.appendChild(a);
                //a.click();
                //document.body.removeChild(a);
                //if (errorMsg)
                //{
                //    alert("Error message: " + errorMsg);
                //}
                //else
                //{
                //    
                //}
            };
            reader.readAsArrayBuffer(file);
        }
    </script>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
